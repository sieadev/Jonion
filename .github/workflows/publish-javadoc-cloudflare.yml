# Build Javadocs and deploy to Cloudflare Pages (siea-javadoc).
# Served at docs.siea.dev/... via a proxy (Pages Function / Worker) that forwards to this Pages project.
name: Publish Javadoc to Cloudflare Pages

on:
  push:
    tags:
      - "v*.*.*"
    branches:
      - javadocs
  workflow_dispatch:

jobs:
  publish-javadoc:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect build tool
        id: tool
        shell: bash
        run: |
          if [ -f pom.xml ]; then
            echo "tool=maven" >> "$GITHUB_OUTPUT"
          elif [ -f build.gradle ] || [ -f build.gradle.kts ]; then
            echo "tool=gradle" >> "$GITHUB_OUTPUT"
          else
            echo "::error::No build tool found. Expected pom.xml or build.gradle(.kts)."
            exit 1
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: ${{ steps.tool.outputs.tool }}

      - name: Extract version (Maven)
        if: steps.tool.outputs.tool == 'maven'
        id: version_maven
        shell: bash
        run: |
          V="$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)"
          echo "version=$V" >> "$GITHUB_OUTPUT"

      - name: Extract version (Gradle)
        if: steps.tool.outputs.tool == 'gradle'
        id: version_gradle
        shell: bash
        run: |
          V="$(./gradlew -q properties | awk -F': ' '/^version:/ {print $2; exit}')"
          if [ -z "$V" ]; then
            echo "::error::Gradle version could not be extracted."
            exit 1
          fi
          echo "version=$V" >> "$GITHUB_OUTPUT"

      - name: Set version
        id: version
        shell: bash
        run: |
          V="${{ steps.version_maven.outputs.version }}"
          if [ -z "$V" ]; then
            V="${{ steps.version_gradle.outputs.version }}"
          fi
          if [ -z "$V" ]; then
            echo "::error::Version could not be extracted."
            exit 1
          fi
          echo "version=$V" >> "$GITHUB_OUTPUT"

      # Build Javadocs as HTML (no need to rely on a *-javadoc.jar existing)
      - name: Build Javadoc (Maven)
        if: steps.tool.outputs.tool == 'maven'
        shell: bash
        run: mvn -q javadoc:javadoc -Ddoclint=none

      - name: Build Javadoc (Gradle)
        if: steps.tool.outputs.tool == 'gradle'
        shell: bash
        run: ./gradlew -q javadoc

      - name: Assemble deploy directory
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if [[ "$VERSION" == *-SNAPSHOT ]]; then
            VERSION_DIR="snapshot"
          else
            VERSION_DIR="$VERSION"
          fi

          rm -rf site
          mkdir -p "site/$VERSION_DIR" site/latest

          if [ "${{ steps.tool.outputs.tool }}" = "maven" ]; then
            JAVADOC_DIR="target/site/apidocs"
          else
            JAVADOC_DIR="build/docs/javadoc"
          fi

          if [ ! -d "$JAVADOC_DIR" ]; then
            echo "::error::Javadoc directory not found at $JAVADOC_DIR"
            exit 1
          fi

          cp -R "$JAVADOC_DIR"/. "site/$VERSION_DIR"/
          cp -R "$JAVADOC_DIR"/. site/latest/

          echo "Deployed version dir: $VERSION_DIR"

      - name: Sanity check
        shell: bash
        run: |
          if [ ! -f site/latest/index.html ]; then
            echo "::error::site/latest/index.html not found. Javadoc build may have failed or output is in an unexpected location."
            ls -la site/latest || true
            exit 1
          fi

      - name: Check secrets are available
        shell: bash
        run: |
          test -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" || (echo "::error::CLOUDFLARE_API_TOKEN is empty/unavailable" && exit 1)
          test -n "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" || (echo "::error::CLOUDFLARE_ACCOUNT_ID is empty/unavailable" && exit 1)
          test -n "${{ secrets.CF_PAGES_PROJECT_NAME }}" || (echo "::error::CF_PAGES_PROJECT_NAME is empty/unavailable" && exit 1)
          echo "Secrets are present."

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy site --project-name ${{ secrets.CF_PAGES_PROJECT_NAME }} --branch main