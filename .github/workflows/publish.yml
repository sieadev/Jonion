name: Publish to Maven Central

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Setup Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3️⃣ Import GPG key
      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      # 4️⃣ Determine version
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION=${VERSION#v}
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      # 5️⃣ Update pom.xml version if workflow_dispatch
      - name: Update pom.xml version
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s#<version>.*</version>#<version>$VERSION</version>#" pom.xml

      # 6️⃣ Cache Maven dependencies
      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # 7️⃣ Build & verify
      - name: Build & Test
        run: mvn clean verify

      # 8️⃣ Configure Maven settings (OSSRH credentials)
      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
  <settings>
    <servers>
      <server>
        <id>central</id>
        <username>${{ secrets.OSSRH_USERNAME }}</username>
        <password>${{ secrets.OSSRH_TOKEN }}</password>
      </server>
    </servers>
  </settings>
  EOF

# 9️⃣ Publish using central-publishing-maven-plugin
- name: Publish to Maven Central
  env:
    GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
  run: |
    mvn central:publish -B